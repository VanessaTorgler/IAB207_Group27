{% extends "base.html" %}
{% block title %}<title>Bondra – Booking History</title>{% endblock %}

{% block breadcrumbs %}
<div class="bg-light border-bottom">
  <nav class="container small py-2" aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Booking History</li>
    </ol>
  </nav>
</div>
{% endblock %}

{% block header %}
<header class="py-4 border-bottom">
  <div class="container">
    <h1 class="h3 mb-1">Your Bookings</h1>
    <p class="text-muted mb-0">View RSVP confirmations for upcoming and past events.</p>
  </div>
</header>
{% endblock %}

{% block content %}
{% macro badge_class(status) -%}
  {%- if status == 'Open' -%}badge-open
  {%- elif status == 'Past' or status == 'Inactive' -%}badge-inactive
  {%- elif status == 'Cancelled' -%}badge-cancelled
  {%- elif status == 'Sold Out' -%}badge-soldout
  {%- else -%}badge-secondary
  {%- endif -%}
{%- endmacro %}

<main id="main" class="container py-4">
  <ul class="nav nav-tabs" id="historyViews" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="cards-tab" data-bs-toggle="tab" data-bs-target="#cards-pane" type="button"
        role="tab" aria-controls="cards-pane" aria-selected="true">Cards view</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-none d-md-block" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-pane"
        type="button" role="tab" aria-controls="table-pane" aria-selected="false">Table view</button>
    </li>
  </ul>

  <div class="tab-content pt-3" id="historyViewsContent">
    <div class="tab-pane fade show active" id="cards-pane" role="tabpanel" aria-labelledby="cards-tab" tabindex="0">
      {% if not bookings %}
        <div class="card" id="empty-state-cards">
          <div class="card-body text-center text-muted">
            <p class="mb-2">No bookings yet.</p>
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.index') }}">Browse events</a>
          </div>
        </div>
      {% else %}
        <div class="row row-cols-1 row-cols-md-2 g-4" id="cards-grid">
          {% for b in bookings %}
          <div class="col">
            <article class="card h-100">
              <div class="row g-0 h-100">
                <div class="col-4">
                  <img src="{{ b.image_url }}" class="img-fluid rounded-start h-100" style="object-fit: cover;"
                       alt="{{ b.image_alt or ('Cover for ' ~ b.event_title) }}">
                </div>
                <div class="col-8">
                  <div class="card-body d-flex flex-column">
                    <h2 class="h5 card-title mb-1">{{ b.event_title }}</h2>
                    <p class="text-muted small mb-2">{{ b.when_line }}{% if b.location_short %} • {{ b.location_short }}{% endif %}</p>
                    <dl class="row small mb-3">
                      <dt class="col-5">Booking ID</dt>
                      <dd class="col-7">{{ b.booking_id }}</dd>
                      <dt class="col-5">Booked on</dt>
                      <dd class="col-7">{{ b.booked_on_line }}</dd>
                      <dt class="col-5">Tickets</dt>
                      <dd class="col-7">{{ b.tickets }}</dd>
                      <dt class="col-5">Status</dt>
                      <dd class="col-7"><span class="badge rounded-pill {{ badge_class(b.status) }}">{{ b.status }}</span></dd>
                    </dl>
                    <div class="mt-auto d-flex gap-2">
                      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.event_detail', event_id=b.event_id) }}">View event</a>
                      {% if b.cancellable %}
                      <form method="post" action="{{ url_for('bookings.cancel_booking', booking_id=b.booking_id) }}">
                        <button class="btn btn-outline-secondary btn-sm" type="submit">Cancel</button>
                      </form>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </article>
          </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="table-pane" role="tabpanel" aria-labelledby="table-tab" tabindex="0">
      {% if not bookings %}
        <div class="card" id="empty-state-table">
          <div class="card-body text-center text-muted">
            <p class="mb-2">No bookings found.</p>
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.index') }}">Browse events</a>
          </div>
        </div>
      {% else %}
        <div class="card" id="table-wrapper">
          <div class="card-header fw-semibold">All bookings</div>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Event</th>
                  <th scope="col">Booking ID</th>
                  <th scope="col">Booked on</th>
                  <th scope="col">Tickets</th>
                  <th scope="col">Status</th>
                  <th scope="col" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for b in bookings %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <img src="{{ b.thumb_url }}" alt="{{ b.image_alt or '' }}" width="48" height="36"
                           style="object-fit: cover;" class="rounded">
                      <div>
                        <div class="fw-semibold">{{ b.event_title }}</div>
                        <div class="small text-muted">{{ b.date_short }}{% if b.location_short %} • {{ b.location_short }}{% endif %}</div>
                      </div>
                    </div>
                  </td>
                  <td>{{ b.booking_id }}</td>
                  <td>{{ b.booked_on_short }}</td>
                  <td>{{ b.tickets }}</td>
                  <td><span class="badge rounded-pill {{ badge_class(b.status) }}">{{ b.status }}</span></td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.event_detail', event_id=b.event_id) }}">View</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</main>
{% endblock %}