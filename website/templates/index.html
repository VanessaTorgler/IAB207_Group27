{% extends "base.html" %}

{% block title %}
<title>Bondra – Home</title>
{% endblock %}

{% block header %}

<div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
  <div>
    <h1 class="h3 mb-1">Discover Professional Networking Events</h1>
    <p class="text-muted mb-0">Browse by category, filter by format, and check status at a glance.</p>
  </div>

  <!-- Mobile: Filters button (offcanvas) -->
  <div class="d-flex justify-content-center">
    <button class="btn btn-outline-primary d-md-none" type="button" style="min-width:300px;" data-bs-toggle="offcanvas"
      data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas" aria-label="Open filters">
      Filters
    </button>
  </div>

  <!-- Desktop: Host an event shortcut -->
  <a href="{{ url_for('events.createUpdate') }}" class="btn btn-primary d-none d-md-inline-flex">Host an Event</a>
</div>
{% endblock %}

{% block content %}
<!-- Offcanvas Filters (mobile) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
  <div class="offcanvas-header">
    <h2 class="offcanvas-title h5" id="filtersOffcanvasLabel">Filters</h2>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close filters"></button>
  </div>
  <div class="offcanvas-body">
    <form class="row g-2 align-items-end filters-compact" role="search" aria-label="Event filters (mobile)" method="get"
      action="{{ url_for('main.index') }}">
      <div class="col-12">
        <label for="m-search" class="form-label">Search</label>
        <input id="m-search" name="q" value="{{ q or '' }}" type="text" class="form-control form-control-sm"
          placeholder="Search by title, host, or keyword">
      </div>

      <div class="col-12">
        <label for="m-category" class="form-label">Category</label>
        <select id="m-category" name="category" class="form-select form-select-sm">
          <option value="" {{ ''==category_selected and 'selected' or '' }}>All categories</option>
          {% for c in ['Tech & AI','Marketing','Finance','Health','Education'] %}
          <option value="{{ c }}" {{ c==category_selected and 'selected' or '' }}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12">
        <label for="m-format" class="form-label">Format</label>
        <select id="m-format" name="format" class="form-select form-select-sm">
          <option value="" {{ (fmt_selected or '' )=='' and 'selected' or '' }}>Any</option>
          {% for f in ['In-person','Virtual','Hybrid'] %}
          <option value="{{ f }}" {{ fmt_selected==f and 'selected' or '' }}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12">
        <label for="m-status" class="form-label">Status</label>
        <select id="m-status" name="status" class="form-select form-select-sm">
          <option value="" {{ (status_selected or '')=='' and 'selected' or '' }}>Any</option>
          {% for s in ['Open','Sold Out','Cancelled','Inactive'] %}
            <option value="{{ s }}" {{ status_selected==s and 'selected' or '' }}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Price range -->
      <div class="col-12">
        <label class="form-label" for="m-price-min">Price range (AUD)</label>
        <div class="row g-2">
          <div class="col-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">$</span>
              <input id="m-price-min" name="price_min" value="{{ price_min if price_min is not none else '' }}"
                type="number" class="form-control form-control-sm" placeholder="Min" min="0" step="1"
                aria-label="Minimum price in dollars">
            </div>
          </div>
          <div class="col-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">$</span>
              <input id="m-price-max" name="price_max" value="{{ price_max if price_max is not none else '' }}"
                type="number" class="form-control form-control-sm" placeholder="Max" min="0" step="1"
                aria-label="Maximum price in dollars">
            </div>
          </div>
        </div>
        <div class="form-text">Leave blank for no limit.</div>
      </div>

      <!-- Sort By -->
      <div class="col-12">
        <label for="m-sort" class="form-label">Sort by</label>
        <select id="m-sort" name="sort" class="form-select form-select-sm" aria-label="Sort events">
          {% for val,label in [('relevance','Relevance'),
          ('dateSoonest','Date - Soonest first'),
          ('priceLowHigh','Price - Low to high'),
          ('priceHighLow','Price - High to low'),
          ('popularity','Popularity')] %}
          <option value="{{ val }}" {{ sort_selected==val and 'selected' or '' }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 d-flex justify-content-end gap-2">
        <button type="submit" class="btn btn-primary btn-sm w-auto px-3">Apply</button>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm w-auto px-3" data-bs-dismiss="offcanvas">
          Clear
        </a>
      </div>

    </form>
  </div>

</div>

<!-- Inline Filters (desktop) -->
<section class="py-3 d-none d-md-block">
  <div class="container">
    <form class="row g-2 align-items-end filters-compact" role="search" aria-label="Event filters (desktop)" method="get"
      action="{{ url_for('main.index') }}">
      <div class="col-md-4">
        <label for="search" class="form-label">Search</label>
        <input id="search" name="q" value="{{ q or '' }}" type="text" class="form-control form-control-sm"
          placeholder="Search by title, host, or keyword">
      </div>

      <div class="col-md-4">
        <label for="category" class="form-label">Category</label>
        <select id="category" name="category" class="form-select form-select-sm">
          <option value="" {{ ''==category_selected and 'selected' or '' }}>All categories</option>
          {% for c in ['Tech & AI','Marketing','Finance','Health','Education','Sustainability','Remote
          Work','Networking','Entrepreneurship'] %}
          <option value="{{ c }}" {{ c==category_selected and 'selected' or '' }}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label for="format" class="form-label">Format</label>
        <select id="m-format" name="format" class="form-select form-select-sm">
          <option value="" {{ (fmt_selected or '' )=='' and 'selected' or '' }}>Any</option>
          {% for f in ['In-person','Virtual','Hybrid'] %}
          <option value="{{ f }}" {{ fmt_selected==f and 'selected' or '' }}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select id="status" name="status" class="form-select form-select-sm">
          <option value="" {{ (status_selected or '')=='' and 'selected' or '' }}>Any</option>
          {% for s in ['Open','Sold Out','Cancelled','Inactive'] %}
            <option value="{{ s }}" {{ status_selected==s and 'selected' or '' }}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label for="sort" class="form-label">Sort by</label>
        <select id="sort" name="sort" class="form-select form-select-sm" aria-label="Sort events">
          {% for val,label in [('relevance','Relevance'),
          ('dateSoonest','Date - Soonest first'),
          ('priceLowHigh','Price - Low to high'),
          ('priceHighLow','Price - High to low'),
          ('popularity','Popularity')] %}
          <option value="{{ val }}" {{ sort_selected==val and 'selected' or '' }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label" for="price-min">Min price (AUD)</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text">$</span>
          <input id="price-min" name="price_min" value="{{ price_min if price_min is not none else '' }}" type="number"
            class="form-control form-control-sm" placeholder="Min" min="0" step="1" aria-label="Minimum price in dollars">
        </div>
      </div>

      <div class="col-md-2">
        <label class="form-label" for="price-max">Max price (AUD)</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text">$</span>
          <input id="price-max" name="price_max" value="{{ price_max if price_max is not none else '' }}" type="number"
            class="form-control form-control-sm" placeholder="Max" min="0" step="1" aria-label="Maximum price in dollars">
        </div>
      </div>
      <div class="col-md-auto ms-md-auto d-flex justify-content-end align-items-end gap-2">
        <button type="submit" class="btn btn-primary btn-sm w-auto px-3">Apply</button>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm w-auto px-3">Clear filters</a>
      </div>
    </form>

  </div>
</section>

<!-- Status Legend -->
<section class="pb-2">
  <div class="container small text-muted">
    <span class="badge rounded-pill badge-open me-1">Open</span>
    <span class="badge rounded-pill badge-soldout me-1">Sold Out</span>
    <span class="badge rounded-pill badge-cancelled me-1">Cancelled</span>
    <span class="badge rounded-pill badge-inactive">Inactive</span>
  </div>
</section>

<main id="main" class="container py-3">
  <!-- Empty state (hidden by default) -->
  <div class="card d-none" id="home-empty">
    <div class="card-body text-center text-muted">
      <p class="mb-2">No events match your filters.</p>
      <button type="button" class="btn btn-outline-primary btn-sm" aria-label="Clear filters">Clear filters</button>
    </div>
  </div>

  <!-- Events Grid -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4" id="events-grid">
    {% if results and results|length > 0 %}
    {% for r in results %}
    {% set e = r.event %}
    <div class="col">
      <article class="card h-100">
        {% set cover = e.images[0].url if e.images else None %}
        {% if cover %}
        {% if cover.startswith('/') %}
        <img src="{{ cover }}" class="card-img-top" alt="{{ e.title }} cover image">
        {% else %}
        <img src="{{ url_for('static', filename=cover) }}" class="card-img-top" alt="{{ e.title }} cover image">
        {% endif %}
        {% else %}
        <img src="{{ url_for('static', filename='img/founders-breakfast.jpg') }}" class="card-img-top"
          alt="{{ e.title }} cover image">
        {% endif %}
        <div class="card-body d-flex flex-column">
        {% set status = r.status %}
        {% set badge_class = {
          'Open': 'badge-open',
          'Sold Out': 'badge-soldout',
          'Cancelled': 'badge-cancelled',
          'Inactive': 'badge-inactive'
        }[status] %}
        <div class="d-flex justify-content-between align-items-start mb-2">
          <span class="badge rounded-pill {{ badge_class }}">{{ status }}</span>
          <span class="badge text-bg-light">{{ e.event_type or 'General' }}</span>
        </div>
          <h2 class="h5 card-title">{{ e.title }}</h2>
          <p class="card-text text-muted mb-2">
            {% if e.start_at %}{{ e.start_at.strftime('%a, %d %b • %I:%M %p') }}{% endif %}
            {% if e.location_text %} • {{ e.location_text }}{% endif %}
          </p>
          <p class="card-text flex-grow-1">
            {{ (e.description or '')[:140] }}{% if e.description and e.description|length>140 %}…{% endif %}
          </p>
          <div class="d-flex justify-content-between align-items-center mt-auto">
            <div class="d-flex gap-2">
              <a class="btn btn-primary" href="{{ url_for('events.event', event_id=e.id) }}">View details</a>
              {% if r.status == 'Open' %}
                <a class="btn btn-outline-primary" href="{{ url_for('events.event', event_id=e.id) }}">Book</a>
              {% endif %}
            </div>
            <span class="fw-semibold text-primary">
              {% if r.min_price and r.min_price > 0 %}
              ${{ '%.2f'|format(r.min_price) }}
              {% else %}
              FREE
              {% endif %}
            </span>
          </div>
        </div>
      </article>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12">
      <div class="card" id="home-empty">
        <div class="card-body text-center text-muted">
          <p class="mb-2">No events match your filters.</p>
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.index') }}">Clear filters</a>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if pages > 1 %}
  <nav class="mt-4" aria-label="Event pagination">
    <ul class="pagination justify-content-center">
      {% set sep = ('?' ~ base_qs ~ '&') if base_qs else '?' %}

      <li class="page-item {{ not has_prev and 'disabled' or '' }}">
        <a class="page-link" href="{{ has_prev and (url_for('main.index') ~ sep ~ 'page=' ~ prev_page ~ '&per_page=' ~ per_page) or '#' }}">Previous</a>
      </li>
      {% set window = 2 %}
      {% for p in range(max(1, page - window), min(pages, page + window) + 1) %}
        <li class="page-item {{ p==page and 'active' or '' }}">
          <a class="page-link" href="{{ url_for('main.index') ~ sep ~ 'page=' ~ p ~ '&per_page=' ~ per_page }}">{{ p }}</a>
        </li>
      {% endfor %}

      <li class="page-item {{ not has_next and 'disabled' or '' }}">
        <a class="page-link" href="{{ has_next and (url_for('main.index') ~ sep ~ 'page=' ~ next_page ~ '&per_page=' ~ per_page) or '#' }}">Next</a>
      </li>
    </ul>
  </nav>
  {% endif %}
</main>
{% endblock %}