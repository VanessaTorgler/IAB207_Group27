{% extends "base.html" %}
{% block title %}<title>Bondra – My Events</title>{% endblock %}
{% block header %}
  <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <h1 class="h3 mb-1">My Events</h1>
      <p class="text-muted mb-0">Manage events you host.</p>
    </div>
    <a href="{{ url_for("main.createUpdate") }}"
       class="btn btn-primary d-none d-md-inline-flex">Create Event</a>
  </div>
{% endblock %}
{% block content %}
  <main id="main" class="container py-4 min-vh-75">
    <!-- Toolbar -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <div class="text-muted small">{{ events|length }} event{{ events|length != 1 and 's' or '' }}</div>
      <div class="d-inline-flex gap-2">
        <form method="get" class="d-inline-flex align-items-center gap-2">
          <!-- Keep current filters/view -->
          <input type="hidden" name="view" value="{{ view }}">
          <input type="hidden" name="when" value="{{ when_selected }}">
          <input type="hidden" name="format" value="{{ fmt_selected }}">
          <label for="sort" class="small text-muted mb-0">Sort</label>
          <!-- prettier-ignore -->
          <select id="sort"
                  name="sort"
                  class="form-select form-select-sm"
                  onchange="this.form.submit()">
            <option value="upcoming" {{ sort_selected=='upcoming' and 'selected' or '' }}>Upcoming
            </option>
            <option value="created" {{ sort_selected=='created' and 'selected' or '' }}>Recently created
            </option>
            <option value="title" {{ sort_selected=='title' and 'selected' or '' }}>Title A–Z
            </option>
          </select>
        </form>
        <!-- Preserves filters whilst switching between view types -->
        <a href="{{ url_for('main.my_events', view='grid', when=when_selected, format=fmt_selected, sort=sort_selected) }}"
           class="btn btn-sm {% if view!='table' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-grid-3x3-gap-fill me-1"></i> Grid
        </a>
        <a href="{{ url_for('main.my_events', view='table', when=when_selected, format=fmt_selected, sort=sort_selected) }}"
           class="btn btn-sm {% if view=='table' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-table me-1"></i> Table
        </a>
      </div>
    </div>
    <div class="row g-5">
      <!-- Left sidebar -->
      <aside class="col-12 col-md-2">
        <div class="card sidebar-sticky">
          <div class="card-header fw-semibold">Filters</div>
          <div class="card-body small">
            <form method="get" action="{{ url_for("main.my_events") }}">
              <input type="hidden" name="view" value="{{ view }}">
              <div class="mb-3">
                <label for="when" class="form-label">When</label>
                <select id="when" name="when" class="form-select form-select-sm">
                  {% for val,label in [('upcoming','Upcoming'), ('past','Past'), ('all','All')] %}
                    <option value="{{ val }}" {{ when_selected==val and 'selected' or '' }}>{{ label }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="format" class="form-label">Format</label>
                <select id="format" name="format" class="form-select form-select-sm">
                  <option value="" {{ (fmt_selected or '')=='' and 'selected' or '' }}>Any
                  </option>
                  {% for f in ['In-person','Virtual','Hybrid'] %}
                    <option value="{{ f }}" {{ fmt_selected==f and 'selected' or '' }}>{{ f }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary btn-sm" type="submit">Apply</button>
                <a class="btn btn-outline-secondary btn-sm"
                   href="{{ url_for('main.my_events', view=view) }}">Clear</a>
              </div>
            </form>
          </div>
        </div>
      </aside>
      <!-- Right content -->
      <section class="col-12 col-md-10">
        {% if events and events|length > 0 %}
          {% if view == 'table' %}
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th style="width:72px;">Image</th>
                    <th>Title</th>
                    <th style="width:120px;">Status</th>
                    <th style="width:140px;">Tickets</th>
                    <th style="width:120px;">Price</th>
                    <th style="width:180px;">Start</th>
                    <th style="width:120px;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for e in events %}
                    {% set cover = e.images[0].url if e.images else url_for('static', filename='img/founders-breakfast.jpg') %}
                    <tr>
                      <td>
                        <img src="{{ cover }}"
                             alt=""
                             class="img-fluid rounded"
                             style="width:64px;
                                    height:40px;
                                    object-fit:cover">
                      </td>
                      <td class="fw-semibold">{{ e.title }}</td>
                      {% set m = metrics.get(e.id) %}
                      <td>
                        <span class="badge rounded-pill {% if m.status == 'Open' %}badge-open {% elif m.status == 'Cancelled' %}badge-cancelled {% elif m.status == 'Inactive' %}badge-inactive {% elif m.status == 'Sold Out' %}badge-soldout {% else %}text-bg-light{% endif %}">
                          {{ m.status }}
                        </span>
                      </td>
                      <td class="small">{{ m.sold }}/{{ e.capacity if e.capacity is not none else '—' }}</td>
                      <td class="fw-semibold">
                        {% if m.min_price > 0 %}
                          ${{ '%.2f'|format(m.min_price) }}
                        {% else %}
                          FREE
                        {% endif %}
                      </td>
                      <td class="text-muted small">
                        {% if e.start_at %}
                          {{ e.start_at.strftime("%a, %d %b • %I:%M %p") }}
                        {% endif %}
                      </td>
                      <td>
                        <a class="btn btn-sm btn-outline-primary"
                           href="{{ url_for('main.event', event_id=e.id) }}">View</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <!-- Grid cards -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
              {% for e in events %}
                {% set cover = e.images[0].url if e.images else url_for('static', filename='img/founders-breakfast.jpg') %}
                <div class="col">
                  <article class="card h-100">
                    <img src="{{ cover }}"
                         class="card-img-top"
                         alt="{{ e.title }} cover image">
                    <div class="d-flex justify-content-between align-items-start p-3 pt-3 pb-0">
                      {% set m = metrics.get(e.id) %}
                      <span class="badge rounded-pill {% if m.status == 'Open' %}badge-open {% elif m.status == 'Cancelled' %}badge-cancelled {% elif m.status == 'Inactive' %}badge-inactive {% elif m.status == 'Sold Out' %}badge-soldout {% else %}text-bg-light{% endif %}">
                        {{ m.status }}
                      </span>
                      <span class="badge text-bg-light">{{ e.event_type or 'General' }}</span>
                    </div>
                    <div class="card-body d-flex flex-column">
                      <h2 class="h6 card-title mb-1">{{ e.title }}</h2>
                      <p class="text-muted small mb-2">
                        {% if e.start_at %}
                          {{ e.start_at.strftime("%a, %d %b • %I:%M %p") }}
                        {% endif %}
                        {% if e.location_text %}• {{ e.location_text }}{% endif %}
                      </p>
                      <div class="d-flex justify-content-between align-items-center small text-muted mb-3">
                        <span>
                          {% if m.min_price > 0 %}
                            ${{ '%.2f'|format(m.min_price) }}
                          {% else %}
                            FREE
                          {% endif %}
                        </span>
                        <span>{{ m.sold }}/{{ e.capacity if e.capacity is not none else '—' }}</span>
                      </div>
                      <a class="btn btn-primary mt-auto"
                         href="{{ url_for('main.event', event_id=e.id) }}">View Event</a>
                    </div>
                  </article>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <!-- Empty state -->
          <div class="card empty-state my-4">
            <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-5">
              <h2 class="h5 fw-semibold mb-1">You aren’t hosting any events yet</h2>
              <p class="text-muted mb-3">Kick things off by creating your first event.</p>
              <a class="btn btn-primary btn-lg"
                 href="{{ url_for("main.createUpdate") }}">
                <i class="bi bi-plus-circle me-1"></i> Create your first event
              </a>
            </div>
          </div>
        {% endif %}
      </section>
    </div>
  </main>
{% endblock %}
