{% extends "base.html" %}
{% block title %}<title>Bondra – My Events</title>{% endblock %}
{% block header %}
  <div class="container d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <h1 class="h3 mb-1">My Events</h1>
      <p class="text-muted mb-0">Manage events you host.</p>
    </div>
    <a href="{{ url_for("events.createUpdate") }}"
       class="btn btn-primary d-none d-md-inline-flex">Create Event</a>
  </div>
{% endblock %}
{% block content %}
  <main id="main" class="container py-4 min-vh-75">
    <!-- Toolbar -->
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <div class="text-muted small">{{ events|length }} event{{ events|length != 1 and 's' or '' }}</div>
      <div class="d-inline-flex gap-2">
        <form method="get" class="d-inline-flex align-items-center gap-2">
          <!-- Keep current filters/view -->
          <input type="hidden" name="view" value="{{ view }}">
          <input type="hidden" name="when" value="{{ when_selected }}">
          <input type="hidden" name="format" value="{{ fmt_selected }}">
          <input type="hidden" name="q" value="{{ q_text or '' }}">
          <input type="hidden" name="status" value="{{ status_selected or 'all' }}">
          <label for="sort" class="small text-muted mb-0">Sort</label>
          <select id="sort" name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="upcoming" {{ sort_selected=='upcoming' and 'selected' or '' }}>Upcoming
            </option>
            <option value="created" {{ sort_selected=='created' and 'selected' or '' }}>Recently created
            </option>
            <option value="title" {{ sort_selected=='title' and 'selected' or '' }}>Title A–Z
            </option>
          </select>
        </form>
        <!-- Preserves filters whilst switching between view types -->
        <a href="{{ url_for('events.my_events', view='grid', when=when_selected, format=fmt_selected, sort=sort_selected, q=q_text, status=status_selected) }}"
          class="btn btn-sm {% if view!='table' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-grid-3x3-gap-fill me-1"></i> Grid
        </a>

        <a href="{{ url_for('events.my_events', view='table', when=when_selected, format=fmt_selected, sort=sort_selected, q=q_text, status=status_selected) }}"
          class="btn btn-sm {% if view=='table' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-table me-1"></i> Table
        </a>
      </div>
    </div>
    {% if q_text or (status_selected) or (category_selected) or (price_min is not none) or (price_max is not none) %}
      <div class="mb-3 small">
        <span class="text-muted me-2">Active filters:</span>
        {% if q_text %}<span class="badge text-bg-light me-1">Search: “{{ q_text }}”</span>{% endif %}
        {% for s in status_selected %}<span class="badge text-bg-light me-1">{{ s }}</span>{% endfor %}
        {% for c in category_selected %}<span class="badge text-bg-light me-1">{{ c }}</span>{% endfor %}
        {% if price_min is not none %}<span class="badge text-bg-light me-1">Min ${{ '%.2f'|format(price_min) }}</span>{% endif %}
        {% if price_max is not none %}<span class="badge text-bg-light me-1">Max ${{ '%.2f'|format(price_max) }}</span>{% endif %}
        <a class="ms-2" href="{{ url_for('events.my_events', view=view, sort=sort_selected) }}">Reset all</a>
      </div>
    {% endif %}
    <div class="row g-5 align-items-start">
      <!-- Left sidebar -->
      <aside class="col-12 col-md-3">
        <div class="card sidebar-sticky">
          <div class="card-header fw-semibold">Filters</div>
          <div class="card-body small">
            <form method="get" action="{{ url_for('events.my_events') }}" class="filters-grid">
              <!-- keep view + sort so we don’t lose state -->
              <input type="hidden" name="view" value="{{ view }}">
              <input type="hidden" name="sort" value="{{ sort_selected }}">

              <!-- Search (full width) -->
              <div class="grid-full">
                <label for="q" class="form-label">Search</label>
                <input id="q" name="q" class="form-control form-control-sm" placeholder="Title..." value="{{ q_text or '' }}">
              </div>

              <!-- When (left) -->
              <div>
                <label for="when" class="form-label">When</label>
                <select id="when" name="when" class="form-select form-select-sm">
                  {% for val,label in [('upcoming','Upcoming'), ('past','Past'), ('all','All')] %}
                    <option value="{{ val }}" {{ when_selected==val and 'selected' or '' }}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Format (right) -->
              <div>
                <label for="format" class="form-label">Format</label>
                <select id="format" name="format" class="form-select form-select-sm">
                  <option value="" {{ (fmt_selected or '')=='' and 'selected' or '' }}>Any</option>
                  {% for f in ['In-person','Virtual','Hybrid'] %}
                    <option value="{{ f }}" {{ fmt_selected==f and 'selected' or '' }}>{{ f }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Status (left) -->
              <fieldset>
                <legend class="form-label mb-1">Status</legend>
                <div class="check-stack list-scroll">
                  {% for opt in ['Open', 'Sold Out', 'Cancelled', 'Inactive'] %}
                    {% set normalized = opt.lower().replace(' ', '') %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="status-{{ normalized }}"
                            name="status" value="{{ normalized }}"
                            {% if status_selected and normalized in status_selected %}checked{% endif %}>
                      <label class="form-check-label" for="status-{{ normalized }}">{{ opt }}</label>
                    </div>
                  {% endfor %}
                </div>
              </fieldset>

              <!-- Categories (right) -->
              <fieldset>
                <legend class="form-label mb-1">Categories</legend>
                <div class="check-stack list-scroll">
                  {% for cat in all_categories %}
                    {% set cid = 'cat-' ~ loop.index %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="{{ cid }}"
                            name="category" value="{{ cat }}"
                            {% if category_selected and cat in category_selected %}checked{% endif %}>
                      <label class="form-check-label" for="{{ cid }}">{{ cat }}</label>
                    </div>
                  {% endfor %}
                </div>
              </fieldset>

              <!-- Price range (full width) -->
              <div class="grid-full">
                <label class="form-label">Price range (min/max)</label>
                <div class="d-grid" style="grid-template-columns: 1fr 1fr; gap: .5rem;">
                  <input name="price_min" class="form-control form-control-sm" placeholder="Min" type="number" step="0.01"
                        value="{{ price_min if price_min is not none }}">
                  <input name="price_max" class="form-control form-control-sm" placeholder="Max" type="number" step="0.01"
                        value="{{ price_max if price_max is not none }}">
                </div>
              </div>

              <!-- Buttons (two columns) -->
              <div>
                <button class="btn btn-primary btn-sm w-100" type="submit">Apply</button>
              </div>
              <div>
                <a class="btn btn-outline-secondary btn-sm w-100"
                  href="{{ url_for('events.my_events', view=view, sort=sort_selected) }}">Clear</a>
              </div>
            </form>
          </div>
        </div>
      </aside>
      <!-- Right content -->
      <section class="col-12 col-md-9">
        {% if events and events|length > 0 %}
          {% if view == 'table' %}
            <div class="table-responsive-md">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th style="width:140px;">Category</th>
                    <th style="width:110px;">Status</th>
                    <th class="text-nowrap" style="width:90px;">Price</th>
                    <th class="text-nowrap" style="width:110px;">Sold</th>
                    <th style="width:170px;">Start</th>
                    <th class="d-none d-lg-table-cell" style="width:170px;">RSVP closes</th>
                    <th style="width:56px;" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for e in events %}
                    {% set cover = e.images[0].url if e.images else url_for('static', filename='img/founders-breakfast.jpg') %}
                    <tr>
                      <td class="fw-semibold">
                        <div class="truncate-col">
                          <a class="text-reset text-decoration-none" href="{{ url_for('events.event', event_id=e.id) }}">{{ e.title }}</a>
                        </div>
                      </td>
                      <td class="small">
                        {% set cats = tags_map.get(e.id, []) %}
                        {% if cats %}
                          <div class="truncate-col">{{ cats|join(', ') }}</div>
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      {% set m = metrics.get(e.id) %}
                      <td>
                        <span class="badge rounded-pill
                          {% if m.status == 'Open' %}badge-open
                          {% elif m.status == 'Cancelled' %}badge-cancelled
                          {% elif m.status == 'Inactive' %}badge-inactive
                          {% elif m.status == 'Sold Out' %}badge-soldout
                          {% else %}text-bg-light{% endif %}">
                          {{ m.status }}
                        </span>
                      </td>

                      <td class="fw-semibold text-nowrap">
                        {% if m.min_price > 0 %}${{ '%.2f'|format(m.min_price) }}{% else %}FREE{% endif %}
                      </td>

                      <td class="text-nowrap small">
                        {{ m.sold }}/{{ e.capacity if e.capacity is not none else '—' }}
                      </td>

                      <td class="text-muted small">
                        {% if e.start_at %}{{ e.start_at.strftime('%d/%m/%y %I:%M %p') }}{% else %}—{% endif %}
                      </td>

                      <td class="text-muted small d-none d-lg-table-cell">
                        {% if e.rsvp_closes %}{{ e.rsvp_closes.strftime('%d/%m/%y %I:%M %p') }}{% else %}—{% endif %}
                      </td>
                      <td class="text-end">
                        <div class="dropdown position-relative">
                          <button class="btn btn-outline-secondary btn-sm btn-icon dropdown-toggle dropdown-toggle-no-caret"
                                  type="button" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm">
                            <li><a class="dropdown-item" href="{{ url_for('events.event', event_id=e.id) }}">View event</a></li>
                            <li><a class="dropdown-item" href="#">Edit Event</a></li>
                            <li><a class="dropdown-item" href="#">View Attendees</a></li>
                            <li><a class="dropdown-item" href="#">View Analytics</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalInactive-{{ e.id }}">Make Inactive</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalCancel-{{ e.id }}">Cancel Event</a></li>
                          </ul>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <!-- Grid cards -->
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-3">
              {% for e in events %}
                {% set cover = e.images[0].url if e.images else url_for('static', filename='img/founders-breakfast.jpg') %}
                <div class="col">
                  <article class="card h-100 card--compact">
                    <img src="{{ cover }}" class="card-img-top" alt="{{ e.title }} cover image">

                    <div class="d-flex justify-content-between align-items-start p-3 pt-3 pb-0">
                      {% set m = metrics.get(e.id) %}
                      <span class="badge rounded-pill
                        {% if m.status == 'Open' %}badge-open
                        {% elif m.status == 'Cancelled' %}badge-cancelled
                        {% elif m.status == 'Inactive' %}badge-inactive
                        {% elif m.status == 'Sold Out' %}badge-soldout
                        {% else %}text-bg-light{% endif %}">
                        {{ m.status }}
                      </span>

                      <div class="d-inline-flex align-items-center gap-2">
                        <span class="badge text-bg-light">{{ e.event_type or 'General' }}</span>
                        <div class="dropdown">
                          <button class="btn btn-outline-secondary btn-sm btn-icon dropdown-toggle dropdown-toggle-no-caret"
                                  type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="More options">
                            <i class="bi bi-three-dots-vertical"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm">
                            <li><a class="dropdown-item" href="{{ url_for('events.event', event_id=e.id) }}">View Event</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('events.update', event_id=e.id) }}">Edit Event</a></li>
                            <li><a class="dropdown-item" href="#">View Attendees</a></li>
                            <li><a class="dropdown-item" href="#">View Analytics</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalInactive-{{ e.id }}">Make Inactive</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalCancel-{{ e.id }}">Cancel Event</a></li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    <div class="card-body d-flex flex-column">
                      <h2 class="h6 card-title mb-1">
                        <a href="{{ url_for('events.event', event_id=e.id) }}"
                          class="text-reset text-decoration-none">{{ e.title }}</a>
                      </h2>

                      <p class="text-muted small mb-2">
                        {% if e.start_at %}{{ e.start_at.strftime("%a, %d %b • %I:%M %p") }}{% endif %}
                        {% if e.location_text %}• {{ e.location_text }}{% endif %}
                      </p>

                      <div class="d-flex justify-content-between align-items-center small text-muted mb-1">
                        <span>{% if m.min_price > 0 %}${{ '%.2f'|format(m.min_price) }}{% else %}FREE{% endif %}</span>
                        <span>{{ m.sold }}/{{ e.capacity if e.capacity is not none else '—' }}</span>
                      </div>
                    </div>
                  </article>

                </div>
                <!-- Make Inactive modal -->
                <div class="modal fade" id="modalInactive-{{ e.id }}" tabindex="-1" aria-labelledby="modalInactiveLabel-{{ e.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="post" action="{{ url_for('events.event_action', event_id=e.id, view=view) }}">
                        {% if csrf_token %}{{ csrf_token() }}{% endif %}
                        <input type="hidden" name="action" value="inactive">
                        <div class="modal-header">
                          <h5 class="modal-title" id="modalInactiveLabel-{{ e.id }}">Mark event as inactive?</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p class="mb-2"><strong>{{ e.title }}</strong></p>
                          <p class="mb-0 small text-muted">
                            This will end the event now and hide it from upcoming lists. You can still edit the event later.
                          </p>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Keep as is</button>
                          <button type="submit" class="btn btn-primary">Make Inactive</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <!-- Cancel Event modal -->
                <div class="modal fade" id="modalCancel-{{ e.id }}" tabindex="-1" aria-labelledby="modalCancelLabel-{{ e.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="post" action="{{ url_for('events.event_action', event_id=e.id, view=view) }}">
                        {% if csrf_token %}{{ csrf_token() }}{% endif %}
                        <input type="hidden" name="action" value="cancel">
                        <div class="modal-header">
                          <h5 class="modal-title" id="modalCancelLabel-{{ e.id }}">Cancel this event?</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p class="mb-2"><strong>{{ e.title }}</strong></p>
                          <p class="mb-0 small text-muted">
                            Attendees won’t be able to book. Consider notifying existing ticket holders.
                          </p>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Never mind</button>
                          <button type="submit" class="btn btn-danger">Cancel Event</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <!-- Empty state -->
          <div class="card empty-state my-4">
            <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-5">
              <h2 class="h5 fw-semibold mb-1">You aren’t hosting any events yet</h2>
              <p class="text-muted mb-3">Kick things off by creating your first event.</p>
              <a class="btn btn-primary btn-lg"
                 href="{{ url_for("events.createUpdate") }}">
                <i class="bi bi-plus-circle me-1"></i> Create your first event
              </a>
            </div>
          </div>
        {% endif %}
      </section>
    </div>
  </main>
{% endblock %}
